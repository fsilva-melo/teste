<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadeia Viva: Evolu√ß√£o na Natureza</title>
  <link rel="icon" href="data:,">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: transparent; /* ‚Üê Fundo vem da capa, n√£o do body */
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      color: #1b5e20;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    #encyclopediaButton {
      position: absolute;
      top: 15px;
      left: 15px;
      cursor: pointer;
      z-index: 200;
      width: auto;
      height: auto;
    }

    #encyclopediaButton img {
      display: block;
      width: 60px;       /* ‚Üê tamanho reduzido */
      height: auto;
      /* sem sombra, sem borda, sem fundo */
    }

    #configButton {
      display: none;
      pointer-events: none;
      position: absolute;
      top: 15px;
      right: 70px;
      width: 50px;
      height: auto;
      cursor: pointer;
      z-index: 100;
    }
    #encyclopedia {
      position: absolute;
      top: 0;
      left: 0;
      width: 320px;
      height: 100vh;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      box-shadow: 4px 0 15px rgba(0,0,0,0.2);
      overflow-y: auto;
      z-index: 150;
      display: none;
      flex-direction: column;
    }
    #encyclopedia.open {
      display: flex;
    }
    #encyclopedia h2 {
      color: #2e7d32;
      margin-bottom: 15px;
    }
    .entry {
      background: #f1f8e9;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 10px;
      text-align: left;
      border-left: 4px solid #4caf50;
    }
    .entry h3 {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      color: #1b5e20;
    }
    .entry p {
      margin: 4px 0;
      font-size: 14px;
      line-height: 1.4;
    }
    #closeEncyclopedia {
      align-self: flex-end;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    /* === FUNDO DA TELA "EXPLORE A CADEIA ALIMENTAR" === */
    #startScreenBackground {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #e8f5e9 url('assets/capa2.png') no-repeat center center; /* ‚Üê cor de fundo + imagem */
      background-size: cover;
      z-index: 90;
    }
    /* === TELA DE CAPA COM 5 BORBOLETAS === */
    .capa {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('assets/capa.png') no-repeat center center;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 300;
      overflow: hidden;
    }

    .placa {
      position: absolute;
      top: 0; /* ‚Üê Come√ßa exatamente no topo */
      left: 50%;
      transform: translateX(-50%);
      max-width: 28%;
      height: auto;
      animation: balancoPlaca 6s infinite ease-in-out;
      z-index: 100;
    }
    .btn-jogar {
      position: absolute;
      bottom: 6%;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 40px;
      font-size: 1.5rem;
      font-weight: bold;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      z-index: 100;
    }

    .btn-jogar:hover {
      background-color: #1976D2;
      transform: translateY(-2px) translateX(-50%);
    }

    @keyframes balancoPlaca {
      0%, 100% { transform: translateX(-50%) translateY(0) rotate(-3deg); }
      50% { transform: translateX(-50%) translateY(5px) rotate(3deg); }
    }

    .btn-azul {
      background: #2196F3;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
      transition: all 0.2s ease;
    }
    .btn-azul:hover {
      background: #1976D2;
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(33, 150, 243, 0.5);
    }

    /* === TELA "EXPLORE A CADEIA ALIMENTAR" SOBRE A CAPA === */
    #startScreen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(230, 255, 230, 0.92); /* Verde claro */
      backdrop-filter: blur(6px);
      padding: 45px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 600px;
      z-index: 101;
      color: #1b5e20;
    }

    #startScreen h2 {
      font-size: 1.8rem;
      margin-bottom: 20px;
      color: #2e7d32;
    }

    #startScreen p {
      margin-bottom: 22px;
      line-height: 1.6;
      font-size: 1.1rem;
    }

    #startButton {
      background: #8D6E63; /* Marrom madeira */
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      padding: 14px 32px;
      font-size: 1.25rem;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(141, 110, 99, 0.4);
      transition: all 0.2s ease;
    }

    #startButton:hover {
      background: #6D4C41;
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(141, 110, 99, 0.5);
    }

    #gameArea {
      position: relative;
      width: 100vw;
      height: 100vh;
      margin: 0;
      border-radius: 0;
      overflow: hidden;
      box-shadow: none;
    }

    /* Estilos do fundo aqu√°tico */
    #gameArea.aquatic-phase {
      background: url('assets/fundo_do_mar.png') no-repeat center center;
      background-size: cover;
    }

    @keyframes waterWaves {
      0% { background-position: 0 0, 0 0; }
      100% { background-position: 200px 0, 0 100px; }
    }

    @keyframes float {
      0% { transform: translateY(0) translateX(0); opacity: 0.4; }
      100% { transform: translateY(-620px) translateX(100px); opacity: 0.7; }
    }

    @keyframes scuttle {
      0% { transform: translateX(0); }
      100% { transform: translateX(80px); }
    }

    .decoration {
      position: absolute;
      z-index: 2;
      pointer-events: none;
    }

    #gameArea.dimmed .entity {
      visibility: hidden;
    }

    #gameArea.worm-phase,
    #gameArea.frog-phase,
    #gameArea.riparian-phase {
      background: url('assets/floresta_completa.png') no-repeat center center;
      background-size: cover;
    }

    .entity {
      position: absolute;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent !important;
      border: none !important;
      outline: none;
      box-shadow: none;
      z-index: 12;
    }

    .entity img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: transparent !important;
      border: none !important;
      pointer-events: none; /* evita interfer√™ncia em cliques, se necess√°rio */
    }

    .decorative-object {
      position: absolute;
      z-index: 5; /* abaixo das entidades (z-index: 12), acima do fundo */
      pointer-events: none;
    }
    .tree {
      z-index: 6; /* √°rvores um pouco acima de pedras/arbustos para profundidade */
    }
  
    #ui {
      margin-top: 10px;
      background: rgba(255,255,255,0.85);
      padding: 12px 24px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    #vidasDisplay {
      position: absolute;
      top: 15px;
      right: 15px;
      background: white;
      border: 2px solid black;
      border-radius: 10px;
      padding: 6px 12px;
      font-weight: bold;
      color: #d32f2f;
      font-size: 1.1rem;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .hidden { display: none; }

    #energyBarContainer {
      position: absolute;
      top: 20px;
      left: 70px;
      width: 150px;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      overflow: hidden;
      z-index: 100;
    }

    #energyBar {
      height: 100%;
      width: 100%;
      background: #FFD700;
      transition: width 0.3s;
    }

    #startButton,
    #retryButton,
    button[onclick*="onGameOverRetry"],
    button[onclick*="nextPhase"],
    #closeEncyclopedia {
      background: #2196F3;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
      transition: all 0.2s ease;
    }
    button[onclick*="onGameOverRetry"],
    button[onclick*="nextPhase"] {
      padding: 10px 20px;
      font-size: 16px;
    }
    #startButton:hover,
    button[onclick*="onGameOverRetry"]:hover,
    button[onclick*="nextPhase"]:hover,
    #encyclopediaButton:hover,
    #closeEncyclopedia:hover {
      background: #1976D2;
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(33, 150, 243, 0.5);
    }

    /* === CARD DE EVOLU√á√ÉO REESTILIZADO === */
    #win {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      background: #f9f4e8; /* Bege claro elegante */
      border: 3px solid #2e7d32; /* Verde met√°lico */
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25), inset 0 0 10px rgba(46, 125, 50, 0.2);
      z-index: 110;
      overflow: hidden;
      text-align: center;
      padding: 0;
    }

    /* === CARD DE EVOLU√á√ÉO (ESTILO SIMPLES) === */
    #win {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      background: #f9f4e8; /* Bege claro */
      border: 3px solid #2e7d32; /* Borda met√°lica verde */
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      z-index: 110;
      padding: 30px 25px;
      text-align: center;
      color: #1b5e20;
      line-height: 1.5;
    }
    
    /* Conte√∫do principal abaixo da faixa */
    #win .content {
      padding: 30px 25px 25px;
      color: #1b5e20;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      gap: 24px; /* ‚Üê espa√ßamento entre texto e bot√£o */
      align-items: center;
      text-align: center;
    }

    /* Modal da Enciclop√©dia */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal.hidden {
  display: none;
}

.modal-content {
  background: white;
  border-radius: 16px;
  padding: 20px;
  max-width: 90%;
  max-height: 90%;
  overflow-y: auto;
  position: relative;
  text-align: center;
}

.close-btn {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 28px;
  cursor: pointer;
  color: #555;
}

.card-image {
  width: 100%;
  max-width: 300px;
  height: auto;
  margin-bottom: 15px;
}

.card-info h3 {
  margin: 10px 0;
  color: #2e7d32;
}

.card-info p {
  margin: 8px 0;
  line-height: 1.4;
}

.vol-btn {
  width: 36px;
  height: 36px;
  font-size: 18px;
  background: #2196F3;
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.vol-btn:hover {
  background: #0d8aed;
}
/* Estilo fino da barra de rolagem nos navegadores WebKit (Chrome, Edge, Safari) */
#creditsModal ::-webkit-scrollbar {
  width: 8px;
}
#creditsModal ::-webkit-scrollbar-track {
  background: #111;
  border-radius: 4px;
}
#creditsModal ::-webkit-scrollbar-thumb {
  background: #555;
  border-radius: 4px;
}
#creditsModal ::-webkit-scrollbar-thumb:hover {
  background: #777;
}
  </style>
</head>
<body>
  <audio id="backgroundMusic" src="music/musica_jogo.mp3" loop></audio>
  <audio id="menuMusic" src="music/musica_menu.mp3" loop></audio>
  <audio id="clickSound" src="music/click.mp3"></audio>
  <div id="coverScreen" class="capa">
  <img src="assets/placa_capa.png" alt="Cadeia Viva" class="placa" />
  <button id="coverStartButton" class="btn-jogar">Jogar</button>
</div>
  <div id="startScreenBackground" class="hidden" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: url('assets/capa2.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  z-index: -1;
"></div>
  <h1 id="gameTitle" class="hidden">üåø Cadeia Viva: Evolu√ß√£o na Natureza üåø</h1>
  <div id="energyBarContainer" class="hidden">
    <div id="energyBar"></div>
  </div>
  <div id="vidasDisplay" class="hidden">
    <span>‚ù§</span><span id="vidasNumero">2</span>
  </div>
  <!-- Bot√£o de Configura√ß√£o (aparece a partir da tela "Explore") -->
  
  <img id="configButton" src="assets/botao_config.png" alt="Configura√ß√µes" />
  
  <div id="startScreen">
    <h2>üîç Explore a Cadeia Alimentar!</h2>
    <p>Voc√™ ir√° come√ßar como uma minhoca e evoluir√° ao sobreviver.</p>
    <p>Cada fase mostra seu n√≠vel tr√≥fico e o tipo de consumidor voc√™ √©.</p>
    <button id="startButton">Come√ßar</button>
  </div>
  <div id="gameArea">
    <!-- Camada 1: fundo (grama, √°gua, etc.) -->
    <div class="background"></div>

    <!-- Camada 2: personagens (jogador + predadores) -->
    <div id="characters"></div>

    <!-- Camada 3: elementos que cobrem (√°rvores, arbustos, folhagem alta) -->
    <div id="foreground-overlay"></div>
  </div>
  <div id="ui" class="hidden">
    <div id="status">Voc√™ √© uma minhoca. Coma 3 folhas antes do sapo te pegar!</div>
  </div>
  <div id="gameOver" class="hidden">
    <h2>‚ò† Game Over!</h2>
    <p>Voc√™ perdeu todas as suas vidas!</p>
    <button id="retryButton">Tentar Novamente</button>
  </div>
  <div id="win" class="hidden">
    <div class="content">
      <p id="winText"></p>
      <button onclick="mostrarPergunta()" class="btn-azul">Continuar</button>
    </div>
</div>
  </div>
  <div id="encyclopediaButton" title="Abrir Enciclop√©dia" class="hidden">
    <img src="assets/botao_enciclopedia.png" alt="Enciclop√©dia" />
  </div>
  <div id="encyclopedia">
    <button id="closeEncyclopedia">Fechar</button>
    <h2>üìò Enciclop√©dia</h2>
  </div>

  <!-- Modal da Enciclop√©dia (FORA da sidebar!) -->
  <div id="encyclopediaModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-btn" onclick="document.getElementById('encyclopediaModal').classList.add('hidden')">&times;</span>
      <img id="modalCardImage" src="" alt="Card do animal" class="card-image">
      <div id="modalInfo" class="card-info"></div>
    </div>
  </div>

<!-- Modal de Cr√©ditos -->
<div id="creditsModal" class="modal hidden">
  <div style="
    position: relative;
    width: 90%;
    max-width: 600px;
    max-height: 85vh;
    background: rgba(0, 0, 0, 0.75);
    border-radius: 16px;
    padding: 30px;
    overflow-y: auto;
    color: white;
    font-family: 'Segoe UI', sans-serif;
    font-size: 16px;
    line-height: 1.6;
    text-align: center;
    scrollbar-width: thin;
    scrollbar-color: #555 #222;
  ">
    <h2 style="margin-bottom: 20px; font-size: 24px;">Cr√©ditos</h2>
    <p style="margin: 12px 0;">
      2025‚Äì2026, Franciele Silva Melo & Rayla Lima.<br>
      Todos os direitos reservados.
    </p>
    <p style="margin: 12px 0;">
      Cadeia Viva: Evolu√ß√£o na Natureza √© um projeto autoral<br>
      desenvolvido no Brasil.
    </p>
    <p style="margin: 12px 0; font-weight: bold;">Desenvolvimento</p>
    <p style="margin: 12px 0;">
      Programa√ß√£o ¬∑ C√≥digo ¬∑ Game Design ¬∑ Implementa√ß√£o ¬∑ Interface<br>
      <strong>Franciele Silva Melo</strong>
    </p>
    <p style="margin: 12px 0; font-weight: bold;">Suporte Criativo</p>
    <p style="margin: 12px 0;">
      <strong>Rayla Lima</strong>
    </p>
    <p style="margin: 12px 0; font-weight: bold;">Arte e Imagens</p>
    <p style="margin: 12px 0;">
      Imagens geradas por Intelig√™ncia Artificial (IA)<br>
      Cria√ß√£o, edi√ß√£o e adapta√ß√£o:<br>
      <strong>Franciele Silva Melo<br>Rayla Lima</strong>
    </p>
    <p style="margin: 12px 0; font-weight: bold;">M√∫sica e √Åudio</p>
    <p style="margin: 12px 0;">
      M√∫sicas e efeitos sonoros obtidos do Pixabay
    </p>
    <p style="margin: 12px 0; font-weight: bold;">Finalidade Educacional</p>
    <p style="margin: 12px 0;">
      Este jogo foi desenvolvido com fins educacionais.
    </p>
    <p style="margin: 12px 0; font-weight: bold;">Informa√ß√µes da Vers√£o</p>
    <p style="margin: 12px 0;">
      Vers√£o BETA<br>
      Desenvolvido entre 2025 e 2026<br>
      Pode conter bugs ou sofrer altera√ß√µes futuras
    </p>
    <p style="margin: 12px 0; font-style: italic;">
      Qualquer semelhan√ßa com outros projetos, jogos ou obras<br>
      √© mera coincid√™ncia.
    </p>
    <button id="closeCreditsButton" style="
      margin-top: 25px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    ">Fechar</button>
  </div>
</div>

  <!-- ‚úÖ PAIN√âIS DE CONFIGURA√á√ÉO (FORA DE QUALQUER OUTRO ELEMENTO) -->
<div id="configMenu" class="modal hidden" style="background: rgba(0,0,0,0.85); flex-direction: column; align-items: center; justify-content: center;">
  <h2 style="margin-bottom: 30px; font-size: 28px; color: white;">Configura√ß√µes</h2>
  <button id="audioConfigBtn" class="btn-azul" style="margin: 10px; padding: 12px 24px;">Configura√ß√£o</button>
  <button id="creditsFromConfigBtn" class="btn-azul" style="margin: 10px; padding: 12px 24px;">Cr√©ditos</button>
  <button id="closeConfigMenu" style="margin-top: 30px; background: #666; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Voltar</button>
</div>

<div id="audioPanel" class="modal hidden" style="background: rgba(0,0,0,0.85); flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;">
  <h2 style="margin-bottom: 20px; font-size: 26px; color: white;">√Åudio</h2>
  <div style="margin: 15px 0; width: 80%; max-width: 500px;">
    <label style="color: white;">M√∫sica do Jogo</label>
    <div style="display: flex; align-items: center; gap: 10px;">
      <button class="vol-btn" data-audio="game" data-action="dec">‚àí</button>
      <input type="range" id="volGame" min="0" max="100" value="70" style="flex: 1;">
      <button class="vol-btn" data-audio="game" data-action="inc">+</button>
    </div>
  </div>
  <div style="margin: 15px 0; width: 80%; max-width: 500px;">
    <label style="color: white;">M√∫sica do Menu</label>
    <div style="display: flex; align-items: center; gap: 10px;">
      <button class="vol-btn" data-audio="menu" data-action="dec">‚àí</button>
      <input type="range" id="volMenu" min="0" max="100" value="70" style="flex: 1;">
      <button class="vol-btn" data-audio="menu" data-action="inc">+</button>
    </div>
  </div>
  <div style="margin: 15px 0; width: 80%; max-width: 500px;">
    <label style="color: white;">Som de Clique</label>
    <div style="display: flex; align-items: center; gap: 10px;">
      <button class="vol-btn" data-audio="click" data-action="dec">‚àí</button>
      <input type="range" id="volClick" min="0" max="100" value="80" style="flex: 1;">
      <button class="vol-btn" data-audio="click" data-action="inc">+</button>
    </div>
  </div>
  <button id="backFromAudio" style="margin-top: 30px; background: #666; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Voltar</button>
</div>
</body>

  <script>
    // === SISTEMA DE DETEC√á√ÉO AUTOM√ÅTICA DE PLATAFORMA (MOBILE / DESKTOP) ===
const GAME_MODE = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                  ('ontouchstart' in window && navigator.maxTouchPoints > 1)
                  ? 'mobile' : 'desktop';

console.log('Modo detectado:', GAME_MODE);

// Fun√ß√£o para verificar se o modo √© mobile
function isMobile() {
    return GAME_MODE === 'mobile';
}

// Fun√ß√£o para verificar se o modo √© desktop
function isDesktop() {
    return GAME_MODE === 'desktop';
}

// Desativa eventos conflitantes com base no modo
document.addEventListener('keydown', (e) => {
    if (isMobile()) {
        e.preventDefault(); // opcional: evita scroll acidental no mobile com teclas
    }
});

// Impede que eventos de toque sejam processados no desktop
document.addEventListener('touchstart', (e) => {
    if (isDesktop()) {
        e.preventDefault();
        return;
    }
}, { passive: false });

// Se for mobile, garanta que os controles visuais sejam ativados mais tarde (ex: em initPhase ou startGame)
// Se for desktop, n√£o crie bot√µes na tela ‚Äî use apenas teclado/mouse

// Exemplo de uso futuro (opcional): ativar/desativar UI espec√≠fica
if (isMobile()) {
    // Voc√™ pode adicionar aqui l√≥gica futura para criar joystick/bot√µes
    // Ex: criar elementos DOM para controles virtuais quando entrar no jogo
} else {
    // Nada extra: j√° usa teclado/mouse por padr√£o
}

    // === Defini√ß√£o dos n√≠veis tr√≥ficos e tipos ===
    const trophicInfo = {
      'üêõ': { level: 2, type: 'consumidor prim√°rio' },
      'üê∏': { level: 3, type: 'consumidor secund√°rio' },
      'üêç': { level: 4, type: 'consumidor terci√°rio' },
      'ü¶Ö': { level: 5, type: 'consumidor quatern√°rio' },
      'ü™±': { level: 2, type: 'consumidor prim√°rio' },
      'üê†': { level: 3, type: 'consumidor secund√°rio' },
      'ü¶≠': { level: 4, type: 'consumidor terci√°rio' },
      'ü¶à': { level: 5, type: 'consumidor quatern√°rio' }
    };

    function getSpriteName(emoji) {
      const map = {
        // === Cadeia terrestre ===
        'üêõ': 'lagarta',
        'üê∏': 'sapo',
        'üêç': 'cobra',
        'ü¶Ö': 'gaviao',
        'üë®‚Äçü¶Ø': 'cacador',
        'üçÉ': 'planta',
        // === Cadeia aqu√°tica ===
        'ü¶†': 'fitoplancton',
        'ü™±': 'zooplancton',
        'üê†': 'sardinha',
        'ü¶≠': 'foca',
        'ü¶à': 'tubarao',
      };
      return map[emoji] || null;
    }

    // === GERADOR DA ENCICLOP√âDIA ===
    function renderEncyclopediaList() {
      const encyclopedia = document.getElementById('encyclopedia');
      if (!encyclopedia) return;

      // Lista de entradas da enciclop√©dia
      const animais = [
        { id: 'planta', name: 'Planta' },
        { id: 'lagarta', name: 'Lagarta' },
        { id: 'sapo', name: 'Sapo' },
        { id: 'cobra', name: 'Cobra' },
        { id: 'gaviao', name: 'Gavi√£o' },
        { id: 'cacador', name: 'Ca√ßador (Humano)' },
        { id: 'fitoplancton', name: 'Fitopl√¢ncton' },
        { id: 'zooplancton', name: 'Zoopl√¢ncton' },
        { id: 'sardinha', name: 'sardinha' },
        { id: 'foca', name: 'Foca' },
        { id: 'tubarao', name: 'Tubar√£o' },
        { id: 'decompositores_terrestres', name: 'Decompositores Terrestres' },
        { id: 'decompositores_aquaticos', name: 'Decompositores Aqu√°ticos' }
      ];

      // Limpa o conte√∫do anterior
      encyclopedia.innerHTML = `
        <button id="closeEncyclopedia" style="align-self:flex-end;margin-bottom:15px;">Fechar</button>
        <h2>üìò Enciclop√©dia</h2>
        <div id="encyclopediaList" style="display:flex;flex-direction:column;gap:12px;"></div>
      `;

      const listContainer = document.getElementById('encyclopediaList');

      animais.forEach(entry => {
        const item = document.createElement('div');
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.gap = '12px';
        item.style.padding = '10px';
        item.style.background = '#f1f8e9';
        item.style.borderRadius = '10px';
        item.style.cursor = 'pointer';
        item.style.borderLeft = '4px solid #4caf50';

        // Usa entry.id diretamente para o nome do sprite e do card
        item.innerHTML = `
          <img src="assets/${entry.id}.png" alt="${entry.name}" style="width:40px;height:40px;object-fit:contain;background:transparent;">
          <span>${entry.name}</span>
        `;

        item.addEventListener('click', () => {
          // Define o caminho do card usando entry.id + "_card.png"
          document.getElementById('modalCardImage').src = `assets/${entry.id}_card.png`;
          document.getElementById('encyclopediaModal').classList.remove('hidden');
        });

        listContainer.appendChild(item);
      });

      // Reatribui o evento de fechar (j√° que o bot√£o foi recriado)
      document.getElementById('closeEncyclopedia').onclick = () => {
        encyclopedia.classList.remove('open');
      };
    }

    function showEncyclopediaDetail(entry) {
      const list = document.getElementById('encyclopediaList');
      const detail = document.getElementById('encyclopediaDetail');
  
      list.style.display = 'none';
      detail.style.display = 'flex';

      let typeInfo = '';
      if (entry.type === 'produtor') {
        typeInfo = `
          <p><strong>Tipo:</strong> Produtor</p>
          <p><strong>N√≠vel tr√≥fico:</strong> 1</p>
        `;
      } else {
        const consumerTypeLabel = {
          'herb√≠voro': 'Herb√≠voro',
          'carn√≠voro': 'Carn√≠voro',
          'on√≠voro': 'On√≠voro'
        }[entry.consumerType] || entry.consumerType;

        typeInfo = `
          <p><strong>Tipo:</strong> Consumidor</p>
          <p><strong>Tipo de consumidor:</strong> ${consumerTypeLabel}</p>
          <p><strong>N√≠vel tr√≥fico:</strong> ${entry.trophicLevel}</p>
        `;
      }

      detail.innerHTML = `
        <img src="assets/${entry.sprite}" alt="${entry.name}" style="width:120px;height:120px;object-fit:contain;background:transparent;margin-bottom:15px;">
        <h3 style="color:#1b5e20;margin-bottom:10px;">${entry.name}</h3>
        <div style="text-align:center;line-height:1.5;margin-bottom:15px;">
          ${typeInfo}
          <p><strong>Curiosidade:</strong> ${entry.curiosity}</p>
          <p><strong>Import√¢ncia:</strong> ${entry.importance}</p>
        </div>
        <button id="btnBackToList" style="background:#2196F3;color:white;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;">‚Üê Voltar √† lista</button>
      `;

      document.getElementById('btnBackToList').onclick = () => {
        detail.style.display = 'none';
        list.style.display = 'flex';
      };
    }
    
    const chain1 = [
      { playerEmoji: 'üêõ', predatorEmoji: 'üê∏', foodEmoji: 'üçÉ', foodCount: 3, playerSpeed: 8, predatorSpeed: 1.5, status: 'Voc√™ √© uma minhoca (consumidor prim√°rio - n√≠vel tr√≥fico 2). Coma 3 folhas antes do sapo te pegar!', theme: 'worm', foodType: 'leaf' },
      { playerEmoji: 'üê∏', predatorEmoji: 'üêç', foodEmoji: 'üêõ', foodCount: 3, playerSpeed: 9, predatorSpeed: 1.8, status: 'Voc√™ √© um sapo (consumidor secund√°rio - n√≠vel tr√≥fico 3). Ca√ße 3 minhocas antes da cobra te pegar!', theme: 'frog', foodType: 'worm' },
      { playerEmoji: 'üêç', predatorEmoji: 'ü¶Ö', foodEmoji: 'üê∏', foodCount: 3, playerSpeed: 10, predatorSpeed: 2.0, status: 'Voc√™ √© uma cobra (consumidor terci√°rio - n√≠vel tr√≥fico 4). Ca√ße 3 sapos entre as folhas √∫midas da mata ciliar!', theme: 'riparian', foodType: 'frog' },
      { playerEmoji: 'ü¶Ö', predatorEmoji: 'üë®‚Äçü¶Ø', foodEmoji: 'üêç', foodCount: 3, playerSpeed: 11, predatorSpeed: 3.0, status: 'Voc√™ √© um gavi√£o. Sobrevoe a mata ciliar e ca√ße cobras!', theme: 'riparian', foodType: 'snake' }
    ];

    // === CADEIA AQU√ÅTICA REVISADA ===
    const chain2 = [
      { playerEmoji: 'ü™±', predatorEmoji: 'üê†', foodEmoji: 'ü¶†', foodCount: 3, playerSpeed: 5, predatorSpeed: 1.5, status: 'Parab√©ns! Voc√™ est√° na cadeia alimentar aqu√°tica.\nVoc√™ √© um zoopl√¢ncton (consumidor prim√°rio - n√≠vel tr√≥fico 2). Coma 3 bact√©rias antes do peixe te pegar!', theme: 'aquatic', foodType: 'bacteria' },
      { playerEmoji: 'üê†', predatorEmoji: 'ü¶≠', foodEmoji: 'ü™±', foodCount: 3, playerSpeed: 7, predatorSpeed: 2.0, status: 'Voc√™ √© um peixe pequeno (consumidor secund√°rio - n√≠vel tr√≥fico 3). Coma 3 zoopl√¢nctons antes da foca te pegar!', theme: 'aquatic', foodType: 'zooplankton' },
      { playerEmoji: 'ü¶≠', predatorEmoji: 'ü¶à', foodEmoji: 'üê†', foodCount: 3, playerSpeed: 8, predatorSpeed: 3.0, status: 'Voc√™ √© uma foca (consumidor terci√°rio - n√≠vel tr√≥fico 4). Ca√ße 3 peixes antes do tubar√£o te pegar!', theme: 'aquatic', foodType: 'fish' },
    ];

    let currentChain = 1;
    let currentPhase = 0;
    let completedLevels = [];
    let proximaFaseEhAquatica = false;
    let player = { x: 450, y: 500 };
    let predator = { x: 100, y: 100, patrolDirection: { dx: 0, dy: 0 }, patrolTimer: 0 };
    let foods = [];
    let collectedCount = 0;
    let gameOver = false;
    let winPhase = false;
    let animationId = null;
    let moveFoodsId = null;
    let energia = 100;
    let energiaInterval;
    let vidas = 2;
    let isPlayerHidden = false;
    window.decorObjects = [];
    const VIDAS_INICIAIS = 2;
    const ENERGIA_BASE = 100;
    const REDUCAO_POR_FASE = 20;

    const gameArea = document.getElementById('gameArea');
    const statusEl = document.getElementById('status');
    const energyBar = document.getElementById('energyBar');
    const gameOverEl = document.getElementById('gameOver');
    const winEl = document.getElementById('win');
    const startScreen = document.getElementById('startScreen');
    const coverScreen = document.getElementById('coverScreen');
    const coverStartButton = document.getElementById('coverStartButton');
    const startButton = document.getElementById('startButton');
    // const winTitleEl = document.getElementById('winTitle'); // REMOVIDO ‚Äì t√≠tulo √© fixo no HTML
    const winTextEl = document.getElementById('winText');
    const vidasDisplay = document.getElementById('vidasDisplay');
    const encyclopediaButton = document.getElementById('encyclopediaButton');
    const encyclopedia = document.getElementById('encyclopedia');
    const closeEncyclopedia = document.getElementById('closeEncyclopedia');

    encyclopediaButton.addEventListener('click', () => {
      playClickSound();
      renderEncyclopediaList();
      encyclopedia.classList.add('open');
    });
    closeEncyclopedia.addEventListener('click', () => {
      playClickSound();
      encyclopedia.classList.remove('open');
    });

    document.getElementById('retryButton').addEventListener('click', () => {
      playClickSound();
      onGameOverRetry();
    });

    // Bot√£o de configura√ß√£o (imagem)
    document.getElementById('configButton').addEventListener('click', () => {
      playClickSound();
      document.getElementById('configMenu').classList.remove('hidden');
    });

    document.getElementById('closeCreditsButton').addEventListener('click', () => {
      playClickSound();
      document.getElementById('creditsModal').classList.add('hidden');
    });

    // Fechar menu de configura√ß√£o
    document.getElementById('closeConfigMenu').addEventListener('click', () => {
      playClickSound();
      document.getElementById('configMenu').classList.add('hidden');
    });

    // Ir para painel de √°udio
    document.getElementById('audioConfigBtn').addEventListener('click', () => {
      playClickSound();
      loadSavedVolumes();
      document.getElementById('audioPanel').classList.remove('hidden');
      document.getElementById('configMenu').classList.add('hidden');
    });

    // Voltar do √°udio
    document.getElementById('backFromAudio').addEventListener('click', () => {
      playClickSound();
      document.getElementById('audioPanel').classList.add('hidden');
      document.getElementById('configMenu').classList.remove('hidden');
    });

    // Cr√©ditos pelo menu de configura√ß√£o
    document.getElementById('creditsFromConfigBtn').addEventListener('click', () => {
      playClickSound();
      document.getElementById('configMenu').classList.add('hidden');
      document.getElementById('creditsModal').classList.remove('hidden');
    });

    // Controles +/‚àí
    document.querySelectorAll('.vol-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const audioType = btn.dataset.audio;
        const action = btn.dataset.action;
        const delta = action === 'inc' ? 10 : -10;
        updateVolume(audioType, delta);
      });
    });

    // Barras deslizantes
    ['Game', 'Menu', 'Click'].forEach(name => {
      const el = document.getElementById(`vol${name}`);
      el.addEventListener('input', () => {
        volumes[name.toLowerCase()] = parseInt(el.value);
        applyVolumes();
      });
    });

    let playerEl, predatorEl, foodEls = [];

    function atualizarVidas() {
      document.getElementById('vidasNumero').textContent = vidas;
    }
    function atualizarBarraEnergia() {
      const porcentagem = (energia / ENERGIA_BASE) * 100;
      energyBar.style.width = porcentagem + "%";
    }

    function randomPosition() {
      const rect = gameArea.getBoundingClientRect();
      return {
        x: 50 + Math.random() * (rect.width - 100),
        y: 50 + Math.random() * (rect.height - 100)
      };
    }
    
    function getCurrentPhaseData() {
      if (currentChain === 1) return chain1[currentPhase];
      else return chain2[currentPhase];
    }
    function criarCenarioFloresta() {
      window.decorObjects = []; // limpa obst√°culos anteriores

      // === √ÅRVORES (5) ‚Äì s√≥ o TRONCO tem colis√£o ===
      const arvores = [
        { x: 420, y: 240 },
        { x: 1300, y: 260 },
        { x: 960, y: 520 },
        { x: 1400, y: 720 },
        { x: 500, y: 720 }
      ];
      arvores.forEach(pos => {
        // Imagem da √°rvore inteira (tronco + copa)
        const arvore = document.createElement('img');
        arvore.src = 'assets/arvore.png';
        arvore.className = 'decorative-object tree';
        arvore.style.left = (pos.x - 250) + 'px'; // centro visual da imagem
        arvore.style.top = (pos.y - 400) + 'px';
        arvore.style.width = '400px';
        arvore.style.height = 'auto';
        gameArea.appendChild(arvore);

          // TRONCO: colis√£o s√≥lida ‚Äî alinhada ao tronco VISUAL
          // A imagem tem 500x800, mas o tronco come√ßa ~200px abaixo do topo e ~220px √† esquerda do centro
          window.decorObjects.push({
            x: (pos.x - 250) + 220,   // ‚Üê esquerda da imagem + offset do tronco
            y: (pos.y - 400) + 225,   // ‚Üê topo da imagem + in√≠cio do tronco
            width: 30,
            height: 100,
            type: 'solid'
          });

        //  OCULTA√á√ÉO: COPA DA √ÅRVORE (folhas)
        window.decorObjects.push({
          x: pos.x - 200,  // cobre a √°rea das folhas
          y: pos.y - 350,  // come√ßa bem acima
          width: 400,
          height: 250,     // altura da copa
          type: 'occlusion'
        });
      });

      // === ARBUSTOS (2) ‚Äì hideout: esconde jogador da detec√ß√£o do predador ===
      const arbustos = [
        { x: 100, y: 405 },
        { x: 1450, y: 350 },
        { x: 850, y: 70 },
        { x: 900, y: 700 }  
      ];
      arbustos.forEach(pos => { 
        const arbusto = document.createElement('img');
        arbusto.src = 'assets/arbusto.png';
        arbusto.className = 'decorative-object';
        arbusto.style.left = (pos.x - 100) + 'px';
        arbusto.style.top = (pos.y - 100) + 'px';
        arbusto.style.width = '200px';
        gameArea.appendChild(arbusto);

        // √Årea de esconderijo (n√£o bloqueia movimento, s√≥ esconde)
        window.decorObjects.push({
          x: pos.x - 80,
          y: pos.y - 80,
          width: 160,
          height: 100,
          type: 'hideout' // ‚Üê novo tipo!
        });
      });
    }
    function criarCenarioAquatico() {
      window.decorObjects = []; // limpa obst√°culos anteriores

      // === CORAIS (2) ‚Äì s√≥lidos, bloqueiam movimento ===
      const corais = [
        { x: 1400, y: 550 },
        { x: 400, y: 690 },
      ];
      corais.forEach(pos => {
        const coral = document.createElement('img');
        coral.src = 'assets/coral_roxo.png';
        coral.className = 'decorative-object';
        coral.style.left = (pos.x - 60) + 'px'; // ajuste visual
        coral.style.top = (pos.y - 80) + 'px';
        coral.style.width = '120px';
        coral.style.height = 'auto';
        gameArea.appendChild(coral);

        // Colis√£o s√≥lida (tronco-like)
        window.decorObjects.push({
          x: pos.x - 30,
          y: pos.y - 60,
          width: 60,
          height: 90,
          type: 'solid'
        });
      });

      // === ALGAS NOS CANTOS (1) ‚Äì esconderijo ===
      const algasCanto = [
        { x: 1430, y: 590 }  // inferior direito
      ];
      algasCanto.forEach(pos => {
        const alga = document.createElement('img');
        alga.src = 'assets/algas_canto.png';
        alga.className = 'decorative-object';
        alga.style.left = (pos.x - 70) + 'px';
        alga.style.top = (pos.y - 90) + 'px';
        alga.style.width = '280px';
        gameArea.appendChild(alga);

        window.decorObjects.push({
          x: pos.x - 60,
          y: pos.y - 80,
          width: 120,
          height: 100,
          type: 'hideout'
        });
      });

      // === GRUPOS DE ALGAS (4) ‚Äì esconderijo ===
      const gruposAlgas = [
        { x: 190, y: 470 },
        { x: 1100, y: 480 },
        { x: 750, y: 590 }
      ];
      gruposAlgas.forEach(pos => {
        const alga = document.createElement('img');
        alga.src = 'assets/algas.png';
        alga.className = 'decorative-object';
        alga.style.left = (pos.x - 50) + 'px';
        alga.style.top = (pos.y - 70) + 'px';
        alga.style.width = '100px';
        gameArea.appendChild(alga);

        window.decorObjects.push({
          x: pos.x - 40,
          y: pos.y - 60,
          width: 80,
          height: 90,
          type: 'hideout'
        });
      });
    }  
    function moveFoods() {
      if (gameOver || winPhase || !foods.length) return;
      const phase = getCurrentPhaseData();
      const rect = gameArea.getBoundingClientRect();
      const maxX = rect.width - 25;
      const maxY = rect.height - 25;

      // Tipos que N√ÉO se movem
      const staticFoodTypes = ['leaf', 'bacteria']; // ‚Üê planta e fitopl√¢ncton

      foods.forEach((food, i) => {
        if (food.collected) return;

        // S√≥ move se N√ÉO for planta ou fitopl√¢ncton
        if (!staticFoodTypes.includes(phase.foodType)) {
          // Inicializa dire√ß√£o aleat√≥ria na primeira vez
          if (!food.dx || !food.dy) {
            food.dx = (Math.random() - 0.5) * 2; // -1 a +1
            food.dy = (Math.random() - 0.5) * 2;
          }

          // Move com velocidade suave
          food.x += food.dx * 1.0;
          food.y += food.dy * 1.0;

         // Rebate nas bordas
         if (food.x <= 25 || food.x >= maxX) food.dx *= -1;
         if (food.y <= 25 || food.y >= maxY) food.dy *= -1;

         // Limita dentro dos limites
         food.x = Math.max(25, Math.min(maxX, food.x));
         food.y = Math.max(25, Math.min(maxY, food.y));
        }

        // Atualiza posi√ß√£o visual
        foodEls[i].style.left = (food.x - 25) + 'px';
        foodEls[i].style.top = (food.y - 25) + 'px';
      });

      moveFoodsId = requestAnimationFrame(moveFoods);
    }
    function initPhase() {
      // Sincroniza currentChain com currentMode (se o bot√£o estiver ativo)
      if (typeof currentMode !== 'undefined') {
        currentChain = currentMode === 'aquatic' ? 2 : 1;
      }
      
      if (animationId) cancelAnimationFrame(animationId);
      if (moveFoodsId) cancelAnimationFrame(moveFoodsId);
      clearInterval(energiaInterval);

      const phase = getCurrentPhaseData();
      // O jogador come√ßa como consumidor prim√°rio ‚Üí j√° perdeu 20%
      energia = ENERGIA_BASE - ((currentPhase + 1) * REDUCAO_POR_FASE);
      if (energia < 20) energia = 20;

      gameArea.innerHTML = '';

      // Define o fundo da fase
      if (phase.theme === 'worm' || phase.theme === 'frog' || phase.theme === 'riparian') {
        gameArea.className = 'worm-phase';
      } else if (phase.theme === 'aquatic') {
        gameArea.className = 'aquatic-phase';
      }

      // === CEN√ÅRIO DECORATIVO POR AMBIENTE ===
      if (phase.theme === 'aquatic') {
        criarCenarioAquatico();
      } else {
        criarCenarioFloresta();
      }

      // === ENTIDADES DO JOGO ===
      playerEl = document.createElement('div');
      playerEl.className = 'entity';

      const playerSprite = getSpriteName(phase.playerEmoji);
      let playerSize = 50; // padr√£o

      // Ajuste de tamanho harmonioso (ca√ßador √© o maior)
      if (playerSprite === 'sapo') playerSize = 90;
      else if (playerSprite === 'cobra') playerSize = 130;
      else if (playerSprite === 'gaviao') playerSize = 130;
      else if (playerSprite === 'cacador') playerSize = 160;
      else if (playerSprite === 'foca') playerSize = 110;
      else if (playerSprite === 'tubarao') playerSize = 140;

      playerEl.style.width = playerSize + 'px';
      playerEl.style.height = playerSize + 'px';

      if (playerSprite) {
        playerEl.innerHTML = `<img src="assets/${playerSprite}.png" style="width:100%;height:100%;object-fit:contain;">`;
      } else {
        playerEl.textContent = phase.playerEmoji;
      }
      gameArea.appendChild(playerEl);

      if (phase.predatorEmoji) {
        predatorEl = document.createElement('div');
        predatorEl.className = 'entity';

        const predatorSprite = getSpriteName(phase.predatorEmoji);
        let predatorSize = 50;

        if (predatorSprite === 'sapo') predatorSize = 90;
        else if (predatorSprite === 'cobra') predatorSize = 130;
        else if (predatorSprite === 'gaviao') predatorSize = 130;
        else if (predatorSprite === 'cacador') predatorSize = 160;
        else if (predatorSprite === 'foca') predatorSize = 110;
        else if (predatorSprite === 'tubarao') predatorSize = 140;

        predatorEl.style.width = predatorSize + 'px';
        predatorEl.style.height = predatorSize + 'px';

        if (predatorSprite) {
          predatorEl.innerHTML = `<img src="assets/${predatorSprite}.png" style="width:100%;height:100%;object-fit:contain;">`;
        } else {
          predatorEl.textContent = phase.predatorEmoji;
        }
        gameArea.appendChild(predatorEl);
      } else {
        predatorEl = null;
      }

      foodEls = [];
      foods = [];
      for (let i = 0; i < phase.foodCount; i++) {
        const food = document.createElement('div');
        food.className = 'entity';
        food.innerHTML = `<img src="assets/${getSpriteName(phase.foodEmoji)}.png" style="width:100%;height:100%;object-fit:contain;">`;
        gameArea.appendChild(food);
        foodEls.push(food);
        foods.push({ ...randomPosition(), collected: false });
      }

      player.x = 450;
      player.y = 500;
      if (predatorEl) {
        const rect = gameArea.getBoundingClientRect();
        predator.x = Math.random() > 0.5 ? 50 : rect.width - 50;
        predator.y = (rect.height / 2) + (Math.random() * 100 - 50);
      }

      statusEl.textContent = phase.status.replace('\n', ' ');
      collectedCount = 0;
      winPhase = false;
      gameOver = false;
      gameOverEl.classList.add('hidden');
      winEl.classList.add('hidden');

      atualizarBarraEnergia();
      // N√£o reduz energia no √∫ltimo n√≠vel de cada cadeia (gavi√£o e tubar√£o)
      if (!((currentChain === 1 && currentPhase === chain1.length - 1) ||
            (currentChain === 2 && currentPhase === chain2.length - 1))) {
      }
      updateDisplay();

      document.getElementById('vidasDisplay').classList.remove('hidden');
      document.getElementById('encyclopediaButton').classList.remove('hidden');
      document.getElementById('energyBarContainer').classList.remove('hidden');

      if (predatorEl) {
        movePredator();
      }
      // Move comidas mesmo sem predador (ex: fase final)  
        moveFoods();
    }

    // S√≥ cria controles se for mobile
    if (isMobile()) {
	      // Exemplo: bot√£o "Correr" (voc√™ pode expandir depois)
	      const btnCorrer = document.createElement('div');
	      btnCorrer.className = 'mobile-control';
	      btnCorrer.style.cssText = `
		        position: absolute;
		        bottom: 20px;
		        right: 20px;
		        width: 70px;
		        height: 70px;
	        	background: rgba(33, 150, 243, 0.8);
	        	border-radius: 50%;
	        	display: flex;
	         	align-items: center;
	        	justify-content: center;
		        color: white;
		        font-weight: bold;
		        font-size: 16px;
		        user-select: none;
		        z-index: 100;
	      `;
	      btnCorrer.textContent = 'üèÉ';
	      btnCorrer.addEventListener('touchstart', (e) => {
		        e.preventDefault();
		        // A√ß√£o futura: aumentar velocidade temporariamente
	      });
	      document.body.appendChild(btnCorrer);
    }
    function updateDisplay() {
      // Centraliza√ß√£o din√¢mica (funciona com qualquer tamanho)
      playerEl.style.left = (player.x - playerEl.offsetWidth / 2) + 'px';
      playerEl.style.top = (player.y - playerEl.offsetHeight / 2) + 'px';

      if (predatorEl) {
        predatorEl.style.left = (predator.x - predatorEl.offsetWidth / 2) + 'px';
        predatorEl.style.top = (predator.y - predatorEl.offsetHeight / 2) + 'px';
      }

      // Atualiza posi√ß√£o e visibilidade das comidas
      foodEls.forEach((el, i) => {
      if (!foods[i].collected) {
        el.style.left = (foods[i].x - 25) + 'px';
        el.style.top = (foods[i].y - 25) + 'px';
        el.style.display = 'flex';
      } else {
        el.style.display = 'none';
      }
    });

    // === Y-SORT inicial (baseado em Y para profundidade) ===
    playerEl.style.zIndex = Math.floor(player.y);
    if (predatorEl) {
      predatorEl.style.zIndex = Math.floor(predator.y);
    }
    foodEls.forEach((el, i) => {
      if (!foods[i].collected) {
        el.style.zIndex = Math.floor(foods[i].y);
      }
    });

    // === VERIFICA OCULTA√á√ÉO DO JOGADOR ===
    const playerCenter = { x: player.x, y: player.y };
    let isPlayerInHideout = false;        // impede persegui√ß√£o
    let isPlayerVisuallyOccluded = false; // s√≥ efeito visual

    if (window.decorObjects) {
      for (const obj of window.decorObjects) {
        const inObj = (
          playerCenter.x >= obj.x &&
          playerCenter.x <= obj.x + obj.width &&
          playerCenter.y >= obj.y &&
          playerCenter.y <= obj.y + obj.height
        );

        if (obj.type === 'hideout' && inObj) {
          isPlayerInHideout = true;
        }

        if ((obj.type === 'occlusion' || obj.type === 'hideout') && inObj) {
          isPlayerVisuallyOccluded = true;
        }
      }
    }

    // Atualiza vari√°vel global usada na l√≥gica de persegui√ß√£o
    isPlayerHidden = isPlayerInHideout;

    // Aplica efeitos visuais no jogador
   playerEl.style.opacity = isPlayerVisuallyOccluded ? '0.5' : '1';
   playerEl.style.zIndex = isPlayerVisuallyOccluded ? '4' : Math.floor(player.y);

    // === TRANSPAR√äNCIA DO PREDADOR AO PASSAR ATR√ÅS DE OBST√ÅCULOS ===
    if (predatorEl && window.decorObjects) {
      let predatorOccluded = false;
      const predCenter = { x: predator.x, y: predator.y };

      for (const obj of window.decorObjects) {
        if ((obj.type === 'occlusion' || obj.type === 'hideout') &&
            predCenter.x >= obj.x &&
            predCenter.x <= obj.x + obj.width &&
            predCenter.y >= obj.y &&
            predCenter.y <= obj.y + obj.height) {
          predatorOccluded = true;
          break;
        }
      }

      predatorEl.style.opacity = predatorOccluded ? '0.4' : '1';
      predatorEl.style.zIndex = predatorOccluded ? '4' : Math.floor(predator.y);
   }
  }

  // === CONTROLES UNIFICADOS: TECLADO + TOQUE ===
  let touchStartX = 0, touchStartY = 0;

  function handlePlayerInput(dx, dy) {
	    if (gameOver || winPhase) return;
	    const phase = getCurrentPhaseData();
	    const speed = phase.playerSpeed;
	    const rect = gameArea.getBoundingClientRect();
	    const maxX = rect.width - 25;
	    const maxY = rect.height - 25;

	    let newX = player.x + dx * speed;
	    let newY = player.y + dy * speed;

	    newX = Math.max(25, Math.min(maxX, newX));
	    newY = Math.max(25, Math.min(maxY, newY));

	    if (!checkCollisionAt(newX, newY)) {
	  	  player.x = newX;
		    player.y = newY;
		   checkCollisions();
		   updateDisplay();
	    }
  }

// Teclado (s√≥ ativo no desktop)
if (isDesktop()) {
	document.addEventListener('keydown', (e) => {
		let dx = 0, dy = 0;
		if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') dy = -1;
		if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') dy = 1;
		if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') dx = -1;
		if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') dx = 1;
		handlePlayerInput(dx, dy);
	});
}

// Toque (s√≥ ativo no mobile)
if (isMobile()) {
	gameArea.addEventListener('touchstart', (e) => {
		e.preventDefault();
		touchStartX = e.touches[0].clientX;
		touchStartY = e.touches[0].clientY;
	}, { passive: false });

	gameArea.addEventListener('touchmove', (e) => {
		e.preventDefault();
		const touchX = e.touches[0].clientX;
		const touchY = e.touches[0].clientY;
		const dx = touchX - touchStartX;
		const dy = touchY - touchStartY;

		let inputDx = 0, inputDy = 0;
		if (Math.abs(dx) > Math.abs(dy)) {
			inputDx = dx > 0 ? 1 : -1;
		} else {
			inputDy = dy > 0 ? 1 : -1;
		}

		handlePlayerInput(inputDx, inputDy);
		touchStartX = touchX;
		touchStartY = touchY;
	}, { passive: false });
}

    function movePredator() {
      if (gameOver || winPhase || !predatorEl) {
        animationId = requestAnimationFrame(movePredator);
        return;
      }

      const phase = getCurrentPhaseData();
      const rect = gameArea.getBoundingClientRect();
      const maxX = rect.width - 25;
      const maxY = rect.height - 25;

      let dx = 0, dy = 0;

      if (isPlayerHidden) {
        // === PATRULHA ALEAT√ìRIA ===
        predator.patrolTimer++;
        if (predator.patrolTimer > 120) {
          predator.patrolDirection = {
            dx: (Math.random() - 0.5) * 2,
            dy: (Math.random() - 0.5) * 2
          };
          predator.patrolTimer = 0;
        }
        dx = predator.patrolDirection.dx * phase.predatorSpeed;
        dy = predator.patrolDirection.dy * phase.predatorSpeed;
      } else {
        // === PERSEGUI√á√ÉO ===
        const toPlayerX = player.x - predator.x;
        const toPlayerY = player.y - predator.y;
        const dist = Math.sqrt(toPlayerX * toPlayerX + toPlayerY * toPlayerY);
        if (dist > 0) {
          dx = (toPlayerX / dist) * phase.predatorSpeed;
          dy = (toPlayerY / dist) * phase.predatorSpeed;
        }
      }

      // Encontra a melhor dire√ß√£o livre
      const result = findBestFreeDirection(dx, dy, phase.predatorSpeed);

      // Aplica o movimento
      predator.x += result.dx;
      predator.y += result.dy;

      // Limita aos limites da tela
      predator.x = Math.max(25, Math.min(maxX, predator.x));
      predator.y = Math.max(25, Math.min(maxY, predator.y));

      // Verifica captura (s√≥ se jogador n√£o estiver escondido)
      if (!isPlayerHidden) {
        const distToPlayer = Math.sqrt(
          Math.pow(player.x - predator.x, 2) + Math.pow(player.y - predator.y, 2)
        );
        if (distToPlayer < 40) {
          perderVida();
          return;
        }
      }

      updateDisplay();
      animationId = requestAnimationFrame(movePredator);
    }

    function checkCollisions() {
      const phase = getCurrentPhaseData();
      foods.forEach((food, i) => {
        if (!food.collected) {
          const dx = player.x - food.x;
          const dy = player.y - food.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < 40) {
            food.collected = true;
            collectedCount++;
            foodEls[i].style.display = 'none';
            if (collectedCount >= phase.foodCount) {
              clearInterval(energiaInterval);
              completedLevels.push({ chain: currentChain, phase: currentPhase });
              winPhase = true;

              // ‚úÖ Verifica se COMPLETOU a cadeia TERRESTRE (gavi√£o)
              if (currentChain === 1 && currentPhase === chain1.length - 1) {
                winTextEl.innerHTML = `
                  <h3 style="margin:0;color:#2e7d32;">üåç Conclus√£o da Cadeia Terrestre!</h3>
                  <p style="margin-top:10px;">Parab√©ns! Voc√™ concluiu a cadeia alimentar terrestre. Agora voc√™ ir√° se aventurar na cadeia aqu√°tica.</p>
                `;
                winEl.classList.remove('hidden');
                proximaFaseEhAquatica = true;
                document.getElementById('gameArea').classList.add('dimmed');
                gameArea.classList.add('dimmed');
              } else {
                // ‚úÖ EVOLU√á√ÉO NORMAL: chama nextPhase() para mostrar "Voc√™ evoluiu"
                nextPhase();
              }
            }
          }
        }
      });
    }
    function perderVida() {
      vidas--;
      atualizarVidas();
      clearInterval(energiaInterval);
      if (vidas > 0) {
        setTimeout(() => initPhase(), 1000);
      } else {
        gameOver = true;
        gameOverEl.classList.remove('hidden');
        statusEl.textContent = 'Voc√™ perdeu todas as suas vidas! üò¢';
      }
    }

    function onGameOverRetry() {
      if (completedLevels.length === 0) {
        currentChain = 1;
        currentPhase = 0;
        vidas = VIDAS_INICIAIS;
      } else {
        const last = completedLevels[completedLevels.length - 1];
        currentChain = last.chain;
        currentPhase = last.phase;
        vidas = VIDAS_INICIAIS;
      }
      atualizarVidas();
      initPhase();
    }

    function restart() {
      clearInterval(energiaInterval);
      currentChain = 1;
      currentPhase = 0;
      vidas = VIDAS_INICIAIS;
      completedLevels = [];
      atualizarVidas();
      startScreen.style.display = 'block';
    }

    function startGame() {
       document.getElementById('configMenu').classList.add('hidden');
       document.getElementById('audioPanel').classList.add('hidden');
       document.getElementById('encyclopediaModal').classList.add('hidden');
     
       //  TOCAR SONS
       playClickSound();      // som de clique ao clicar em "Come√ßar"
       stopMenuMusic();       // para a m√∫sica do menu
       playBackgroundMusic(); // inicia a m√∫sica do jogo

        //  L√ìGICA ORIGINAL DO JOGO
        startScreen.style.display = 'none';
        document.getElementById('startScreenBackground').classList.add('hidden');
        document.getElementById('gameTitle').style.display = 'none';
        currentChain = 1;
        currentPhase = 0;
        vidas = VIDAS_INICIAIS;
        completedLevels = [];
        atualizarVidas();
        initPhase();
      }

    document.addEventListener('DOMContentLoaded', () => {
      // S√≥ agora acessamos os elementos, garantindo que existem
      const coverScreen = document.getElementById('coverScreen');
      const startScreen = document.getElementById('startScreen');
      const coverStartButton = document.getElementById('coverStartButton');
      const startButton = document.getElementById('startButton');

      // Registra eventos
      coverStartButton.addEventListener('click', () => {
        playClickSound(); // ‚Üê SOM DE CLIQUE
        playMenuMusic();  // ‚Üê TOCA A M√öSICA DO MENU
        coverScreen.style.display = 'none';
        document.getElementById('startScreenBackground').classList.remove('hidden');
        startScreen.style.display = 'block';
        document.getElementById('encyclopediaButton').classList.remove('hidden');
        setTimeout(() => {
          const cfgBtn = document.getElementById('configButton');
          cfgBtn.style.display = 'block';
          cfgBtn.style.pointerEvents = 'auto';
        }, 300);
        
        document.getElementById('configMenu').classList.add('hidden');
        document.getElementById('audioPanel').classList.add('hidden');
      });

      startButton.addEventListener('click', startGame);

      // Atualiza vidas e carrega volumes salvos
      atualizarVidas();
      loadSavedVolumes();
    });

    // === SISTEMA DE PERGUNTAS EDUCATIVAS (20 perguntas com 3 alternativas) ===
const perguntas = [
  {
    texto: "O que √© cadeia alimentar?",
    opcoes: [
      { texto: "A rela√ß√£o de amizade entre os seres vivos", correta: false },
      { texto: "A sequ√™ncia de seres vivos ligados pela alimenta√ß√£o", correta: true },
      { texto: "O conjunto de animais de um mesmo ambiente", correta: false }
    ],
    explicacao: "A cadeia alimentar mostra como os seres se alimentam uns dos outros."
  },
  {
    texto: "O que s√£o n√≠veis tr√≥ficos?",
    opcoes: [
      { texto: "Os diferentes habitats de um ecossistema", correta: false },
      { texto: "As posi√ß√µes ocupadas pelos seres vivos na cadeia alimentar", correta: true },
      { texto: "Os tipos de solo onde os seres vivos vivem", correta: false }
    ],
    explicacao: "Cada organismo ocupa um n√≠vel tr√≥fico de acordo com sua fun√ß√£o alimentar."
  },
  {
    texto: "Quem ocupa o primeiro n√≠vel tr√≥fico?",
    opcoes: [
      { texto: "Consumidores", correta: false },
      { texto: "Decompositores", correta: false },
      { texto: "Produtores", correta: true }
    ],
    explicacao: "Produtores, como plantas, est√£o sempre no in√≠cio da cadeia."
  },
  {
    texto: "O que s√£o produtores?",
    opcoes: [
      { texto: "Seres vivos que se alimentam de outros seres", correta: false },
      { texto: "Seres vivos que produzem seu pr√≥prio alimento", correta: true },
      { texto: "Seres vivos que se alimentam de mat√©ria em decomposi√ß√£o", correta: false }
    ],
    explicacao: "Eles usam a luz solar para fazer fotoss√≠ntese."
  },
  {
    texto: "Qual √© o principal processo usado pelos produtores para obter energia?",
    opcoes: [
      { texto: "Respira√ß√£o", correta: false },
      { texto: "Fotoss√≠ntese", correta: true },
      { texto: "Digest√£o", correta: false }
    ],
    explicacao: "A fotoss√≠ntese converte luz solar em energia qu√≠mica."
  },
  {
    texto: "O que s√£o consumidores prim√°rios?",
    opcoes: [
      { texto: "Animais que se alimentam de outros animais", correta: false },
      { texto: "Animais que se alimentam de produtores", correta: true },
      { texto: "Seres que produzem seu pr√≥prio alimento", correta: false }
    ],
    explicacao: "Ex: coelho, gafanhoto, zoopl√¢ncton."
  },
  {
    texto: "Um exemplo de consumidor prim√°rio √©:",
    opcoes: [
      { texto: "Le√£o", correta: false },
      { texto: "√Åguia", correta: false },
      { texto: "Coelho", correta: true }
    ],
    explicacao: "O coelho come plantas, ent√£o √© consumidor prim√°rio."
  },
  {
    texto: "O que s√£o consumidores secund√°rios?",
    opcoes: [
      { texto: "Animais que comem produtores", correta: false },
      { texto: "Animais que comem consumidores prim√°rios", correta: true },
      { texto: "Animais que produzem alimento", correta: false }
    ],
    explicacao: "Ex: sapo, peixe pequeno."
  },
  {
    texto: "O que √© teia alimentar?",
    opcoes: [
      { texto: "Uma √∫nica cadeia alimentar", correta: false },
      { texto: "Um conjunto de cadeias alimentares interligadas", correta: true },
      { texto: "Um tipo de solo", correta: false }
    ],
    explicacao: "Na natureza, as cadeias se cruzam formando teias complexas."
  },
  {
    texto: "O que s√£o consumidores terci√°rios?",
    opcoes: [
      { texto: "Animais que se alimentam de plantas", correta: false },
      { texto: "Animais que se alimentam de consumidores secund√°rios", correta: true },
      { texto: "Seres que realizam fotoss√≠ntese", correta: false }
    ],
    explicacao: "Ex: cobra, foca."
  },
  {
    texto: "O que s√£o decompositores?",
    opcoes: [
      { texto: "Animais carn√≠voros", correta: false },
      { texto: "Seres vivos que produzem energia", correta: false },
      { texto: "Seres vivos que decomp√µem mat√©ria org√¢nica", correta: true }
    ],
    explicacao: "Fungos e bact√©rias reciclam mat√©ria morta."
  },
  {
    texto: "Qual √© a principal diferen√ßa entre cadeia alimentar e teia alimentar?",
    opcoes: [
      { texto: "A cadeia alimentar √© mais complexa que a teia alimentar", correta: false },
      { texto: "A teia alimentar representa v√°rias cadeias interligadas", correta: true },
      { texto: "A teia alimentar n√£o possui produtores", correta: false }
    ],
    explicacao: "A teia mostra a realidade mais completa do ecossistema."
  },
  {
    texto: "Qual √© a import√¢ncia dos decompositores na cadeia alimentar?",
    opcoes: [
      { texto: "Produzir alimento", correta: false },
      { texto: "Reciclar nutrientes no ambiente", correta: true },
      { texto: "Consumir energia solar", correta: false }
    ],
    explicacao: "Sem eles, os nutrientes ficariam presos em corpos mortos."
  },
  {
    texto: "O que √© fluxo de energia?",
    opcoes: [
      { texto: "A passagem de mat√©ria entre os seres vivos", correta: false },
      { texto: "A circula√ß√£o da √°gua nos ecossistemas", correta: false },
      { texto: "A transfer√™ncia de energia ao longo da cadeia alimentar", correta: true }
    ],
    explicacao: "A energia flui do sol ‚Üí planta ‚Üí herb√≠voro ‚Üí carn√≠voro."
  },
  {
    texto: "Como o fluxo de energia ocorre na cadeia alimentar?",
    opcoes: [
      { texto: "Do consumidor para o produtor", correta: false },
      { texto: "Do produtor para os consumidores", correta: true },
      { texto: "Dos decompositores para os produtores", correta: false }
    ],
    explicacao: "A energia sempre come√ßa nos produtores."
  },
  {
    texto: "O fluxo de energia na cadeia alimentar √©:",
    opcoes: [
      { texto: "C√≠clico, retorna ao in√≠cio", correta: false },
      { texto: "Inexistente", correta: false },
      { texto: "Unidirecional, n√£o retorna", correta: true }
    ],
    explicacao: "A energia entra pelo sol e sai como calor ‚Äî n√£o volta."
  },
  {
    texto: "O que acontece com a energia ao passar de um n√≠vel tr√≥fico para outro?",
    opcoes: [
      { texto: "Aumenta", correta: false },
      { texto: "Diminui", correta: true },
      { texto: "Permanece igual", correta: false }
    ],
    explicacao: "Cerca de 90% da energia √© perdida como calor!"
  },
  {
    texto: "Por que h√° menos energia nos n√≠veis tr√≥ficos mais altos?",
    opcoes: [
      { texto: "Porque os produtores usam toda a energia", correta: false },
      { texto: "Porque parte da energia √© perdida em forma de calor", correta: true },
      { texto: "Porque os decompositores consomem toda a energia", correta: false }
    ],
    explicacao: "Isso limita o n√∫mero de n√≠veis tr√≥ficos (geralmente 3‚Äì5)."
  },
  {
    texto: "O que √© uma teia alimentar?", // duplicada propositalmente? Mantive conforme seu pedido.
    opcoes: [
      { texto: "Uma √∫nica sequ√™ncia alimentar", correta: false },
      { texto: "Um conjunto de cadeias alimentares interligadas", correta: true },
      { texto: "Um tipo de habitat", correta: false }
    ],
    explicacao: "Representa a complexidade das rela√ß√µes alimentares na natureza."
  },
  {
    texto: "Qual √© a principal fonte de energia da maioria das cadeias alimentares?",
    opcoes: [
      { texto: "A Lua", correta: false },
      { texto: "O vento", correta: false },
      { texto: "O Sol", correta: true }
    ],
    explicacao: "Sem o sol, n√£o haveria fotoss√≠ntese nem vida animal."
  }
];

let perguntasUsadas = [];
let perguntaAtual = null;

function mostrarPergunta() {
  // Escolher pergunta n√£o usada
  const perguntasDisponiveis = perguntas.filter((_, i) => !perguntasUsadas.includes(i));
  if (perguntasDisponiveis.length === 0) {
    perguntasUsadas = []; // reinicia se todas foram usadas
    return mostrarPergunta();
  }
  const indice = Math.floor(Math.random() * perguntasDisponiveis.length);
  const pergunta = perguntasDisponiveis[indice];
  const indiceOriginal = perguntas.indexOf(pergunta);
  perguntasUsadas.push(indiceOriginal);
  perguntaAtual = pergunta;

  gameArea.classList.add('dimmed');

  // Criar tela de pergunta com 3 op√ß√µes
  const telaPergunta = document.createElement('div');
  telaPergunta.id = 'telaPergunta';
  telaPergunta.innerHTML = `
    <div style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      z-index: 120;
      text-align: center;
      min-width: 320px;
      max-width: 90%;
      font-size: 16px;
      line-height: 1.4;
    ">
      <h3 style="margin-bottom: 20px; color: #1976D2;">Pergunta Educativa</h3>
      <p style="margin-bottom: 20px;">${pergunta.texto}</p>
      <div id="opcaoA" style="
        background: #e3f2fd;
        padding: 12px;
        margin: 8px 0;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.2s;
        border: 2px solid #bbdefb;
      ">A) ${pergunta.opcoes[0].texto}</div>
      <div id="opcaoB" style="
        background: #e3f2fd;
        padding: 12px;
        margin: 8px 0;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.2s;
        border: 2px solid #bbdefb;
      ">B) ${pergunta.opcoes[1].texto}</div>
      <div id="opcaoC" style="
        background: #e3f2fd;
        padding: 12px;
        margin: 8px 0;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.2s;
        border: 2px solid #bbdefb;
      ">C) ${pergunta.opcoes[2].texto}</div>
      <div id="feedback" style="margin: 15px 0; min-height: 24px; font-weight: bold;"></div>
      <button id="btnContinuar" style="
        background: #2196F3;
        color: white;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
        display: none;
      ">Continuar</button>
    </div>
  `;
  document.getElementById('gameArea').classList.add('dimmed');
  document.body.appendChild(telaPergunta);

  // Eventos de clique
  document.getElementById('opcaoA').addEventListener('click', () => { playClickSound(); responder(0); });
  document.getElementById('opcaoB').addEventListener('click', () => { playClickSound(); responder(1); });
  document.getElementById('opcaoC').addEventListener('click', () => { playClickSound(); responder(2); });
}

function responder(escolha) {
  const correta = perguntaAtual.opcoes[escolha].correta;
  const feedbackEl = document.getElementById('feedback');
  const opcoes = ['opcaoA', 'opcaoB', 'opcaoC'].map(id => document.getElementById(id));

  // Destacar cores
  opcoes.forEach((el, i) => {
    el.style.backgroundColor = perguntaAtual.opcoes[i].correta ? '#c8e6c9' : '#ffcdd2';
  });

  if (correta) {
    feedbackEl.style.color = '#2e7d32';
    feedbackEl.textContent = '‚úÖ Resposta correta! Muito bem!';
  } else {
    feedbackEl.style.color = '#d32f2f';
    feedbackEl.textContent = `‚ùå Resposta incorreta. ${perguntaAtual.explicacao}`;
  }

  //  ESSENCIAL: mostra o bot√£o "Continuar"
  const btnContinuar = document.getElementById('btnContinuar');
  btnContinuar.style.display = 'inline-block';

  btnContinuar.onclick = () => {
    playClickSound();
    document.body.removeChild(document.getElementById('telaPergunta'));
    document.getElementById('gameArea').classList.remove('dimmed');
    iniciarProximaFase();
  };
}

function iniciarProximaFase() {
  if (proximaFaseEhAquatica) {
    proximaFaseEhAquatica = false;
    currentChain = 2;
    currentPhase = 0;
  } else {
    // Avan√ßa normalmente
    currentPhase++;
  }
  vidas = VIDAS_INICIAIS;
  atualizarVidas();
  initPhase();
}

function nextPhase() {
  // Caso especial: conclus√£o da cadeia TERRESTRE (j√° tratado em checkCollisions)
  // Caso: conclus√£o da cadeia AQU√ÅTICA ‚Üí volta para a tela "Explore a Cadeia Alimentar"
  if (currentChain === 2 && currentPhase === chain2.length - 1) {
    // Mostra mensagem de conclus√£o por 3 segundos, depois volta
    winTextEl.innerHTML = `
      <h3 style="margin:0;color:#2e7d32;">üåç Conclus√£o Total!</h3>
      <p style="margin-top:10px;">Parab√©ns! Voc√™ completou a cadeia alimentar aqu√°tica e viu como a energia flui at√© os grandes predadores.</p>
    `;
    winEl.classList.remove('hidden');
    gameArea.classList.add('dimmed');

    // Ap√≥s 3 segundos, volta para a tela inicial de sele√ß√£o
    setTimeout(() => {
      // Esconde elementos do jogo
      winEl.classList.add('hidden');
      gameArea.classList.remove('dimmed');
      gameArea.innerHTML = '';
      document.getElementById('vidasDisplay').classList.add('hidden');
      document.getElementById('encyclopediaButton').classList.add('hidden');
      document.getElementById('energyBarContainer').classList.add('hidden');
    
      // Mostra a tela "Explore a Cadeia Alimentar"
      document.getElementById('startScreen').style.display = 'block';
      document.getElementById('startScreenBackground').classList.remove('hidden');
    
      // Reinicia estado do jogo
      currentChain = 1;
      currentPhase = 0;
      vidas = VIDAS_INICIAIS;
      completedLevels = [];
      atualizarVidas();
    }, 3000); // 3 segundos

    return;
  }

  // Evolu√ß√£o normal: dentro da mesma cadeia
  const nextPhaseIndex = currentPhase + 1;
  const nextPhaseData = currentChain === 1 ? chain1[nextPhaseIndex] : chain2[nextPhaseIndex];
  const status = nextPhaseData.status;
  const objetivo = status.split('. ').slice(1).join('. ').trim();
  const primeiraFrase = status.split('.')[0];
  let nomePuro = primeiraFrase
    .replace(/^Voc√™ √©\s+/, '')
    .replace(/^voc√™ √©\s+/, '')
    .replace(/\s*\(.*\)/, '')
    .trim();

  const emoji = nextPhaseData.playerEmoji;
  const info = trophicInfo[emoji];
  let nomeComInfo = nomePuro;
  if (info) {
    nomeComInfo = `${nomePuro} (${info.type} ‚Äì n√≠vel tr√≥fico ${info.level})`;
  }

  let mensagem = `Voc√™ virou ${nomeComInfo}.`;
  if (objetivo) {
    mensagem += ` ${objetivo}`;
  }
  if (!mensagem.endsWith('.')) {
    mensagem += '.';
  }

  winTextEl.innerHTML = `
    <h3 style="margin:0;color:#1976D2;">üéâ Voc√™ evoluiu!</h3>
    <p style="margin-top:10px;">${mensagem}</p>
  `;
  winEl.classList.remove('hidden');
  gameArea.classList.add('dimmed');

  // Remove evento antigo se existir
  const btnWin = document.getElementById('btnContinuarWin');
  if (btnWin) {
    btnWin.onclick = null;
    btnWin.addEventListener('click', () => {
      playClickSound();
      mostrarPergunta();
    });
  }
}
function rectsOverlap(a, b) {
  return a.x < b.x + b.width &&
         a.x + a.width > b.x &&
         a.y < b.y + b.height &&
         a.y + a.height > b.y;
}

function isSolidAt(x, y) {
  const hitbox = { x: x - 20, y: y - 20, width: 40, height: 40 };
  if (!window.decorObjects) return false;
  for (const obj of window.decorObjects) {
    if (obj.type === 'solid' && rectsOverlap(hitbox, obj)) {
      return true;
    }
  }
  return false;
}

// Nova fun√ß√£o: encontra a melhor dire√ß√£o livre pr√≥xima √† dire√ß√£o desejada
function findBestFreeDirection(targetDx, targetDy, speed, maxAngle = Math.PI / 2, steps = 8) {
  const baseAngle = Math.atan2(targetDy, targetDx);
  const angles = [];

  // Gera √¢ngulos ao redor da dire√ß√£o alvo (de -maxAngle a +maxAngle)
  for (let i = 0; i <= steps; i++) {
    const angle = baseAngle + (i / steps * 2 - 1) * maxAngle;
    angles.push(angle);
  }

  // Testa cada √¢ngulo em ordem de proximidade com a dire√ß√£o original
  for (const angle of angles) {
    const dx = Math.cos(angle) * speed;
    const dy = Math.sin(angle) * speed;
    if (!isSolidAt(predator.x + dx, predator.y + dy)) {
      return { dx, dy, angle };
    }
  }

  // Se tudo falhar, tenta qualquer dire√ß√£o (360¬∞)
  for (let i = 0; i < 16; i++) {
    const angle = (i / 16) * Math.PI * 2;
    const dx = Math.cos(angle) * speed;
    const dy = Math.sin(angle) * speed;
    if (!isSolidAt(predator.x + dx, predator.y + dy)) {
      return { dx, dy, angle };
    }
  }

  // Nenhuma dire√ß√£o livre ‚Üí n√£o move
  return { dx: 0, dy: 0, angle: baseAngle };
}
function findFreeDirection(baseDx, baseDy, speed, attempts = 8) {
  // Tenta a dire√ß√£o original primeiro
  if (!isSolidAt(predator.x + baseDx * speed, predator.y + baseDy * speed)) {
    return { dx: baseDx, dy: baseDy };
  }

  // Se estiver bloqueado, tenta pequenas rota√ß√µes ao redor
  const angles = [];
  for (let i = 0; i < attempts; i++) {
    const angle = (i / attempts) * Math.PI * 2;
    angles.push(angle);
  }
  // Embaralha para evitar padr√£o
  angles.sort(() => Math.random() - 0.5);

  for (const angle of angles) {
    const dx = Math.cos(angle);
    const dy = Math.sin(angle);
    if (!isSolidAt(predator.x + dx * speed, predator.y + dy * speed)) {
      return { dx, dy };
    }
  }

  // Se tudo falhar, retorna a dire√ß√£o original (mesmo que empurre contra a parede)
  return { dx: baseDx, dy: baseDy };
}

// === FUN√á√ïES DE PATHFINDING SIMPLES ===

function isSolidAt(x, y) {
  const hitbox = { x: x - 20, y: y - 20, width: 40, height: 40 };
  if (!window.decorObjects) return false;
  for (const obj of window.decorObjects) {
    if (obj.type === 'solid' && rectsOverlap(hitbox, obj)) {
      return true;
    }
  }
  return false;
}

// Gera √¢ngulos pr√≥ximos √† dire√ß√£o alvo (¬±90¬∞)
function generateCandidateAngles(targetAngle, steps = 8) {
  const angles = [];
  const maxOffset = Math.PI / 2; // 90 graus
  for (let i = 0; i <= steps; i++) {
    const offset = (i / steps * 2 - 1) * maxOffset;
    angles.push(targetAngle + offset);
  }
  return angles;
}

// Encontra a melhor dire√ß√£o livre pr√≥xima ao alvo
function findBestFreeDirection(targetDx, targetDy, speed) {
  const targetAngle = Math.atan2(targetDy, targetDx);
  const candidateAngles = generateCandidateAngles(targetAngle);

  // Testa primeiro a dire√ß√£o exata
  if (!isSolidAt(predator.x + targetDx, predator.y + targetDy)) {
    return { dx: targetDx, dy: targetDy };
  }

  // Testa √¢ngulos alternativos
  for (const angle of candidateAngles) {
    const dx = Math.cos(angle) * speed;
    const dy = Math.sin(angle) * speed;
    if (!isSolidAt(predator.x + dx, predator.y + dy)) {
      return { dx, dy };
    }
  }

  // Se tudo falhar, tenta qualquer dire√ß√£o (360¬∞)
  for (let i = 0; i < 16; i++) {
    const angle = (i / 16) * Math.PI * 2;
    const dx = Math.cos(angle) * speed;
    const dy = Math.sin(angle) * speed;
    if (!isSolidAt(predator.x + dx, predator.y + dy)) {
      return { dx, dy };
    }
  }

  // Nenhuma sa√≠da ‚Üí n√£o se move
  return { dx: 0, dy: 0 };
}

function checkCollisionAt(x, y) {
  const playerHitbox = {
    x: x - 20,
    y: y - 20,
    width: 40,
    height: 40
  };
  if (!window.decorObjects) return false;
  for (const obj of window.decorObjects) {
    if (obj.type === 'solid' && rectsOverlap(playerHitbox, obj)) {
      return true; // s√≥ bloqueia 'solid'
    }
  }
  return false;
}

// Fecha o modal ao clicar no "X"
document.querySelector('.close-btn').addEventListener('click', () => {
  document.getElementById('encyclopediaModal').classList.add('hidden');
});

// Fecha ao clicar fora do conte√∫do
document.getElementById('encyclopediaModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('encyclopediaModal')) {
    document.getElementById('encyclopediaModal').classList.add('hidden');
  }
});

// === √ÅUDIO E CONTROLES ===
const bgMusic = document.getElementById('backgroundMusic');
const settingsBtn = document.getElementById('settingsButton');
const settingsPanel = document.getElementById('settingsPanel');
const volumeControl = document.getElementById('volumeControl');
const closeSettingsBtn = document.getElementById('closeSettings');
const creditsBtn = document.getElementById('creditsButton');

// Inicializa volume
if (bgMusic) {
  bgMusic.volume = 0.7;
}

// Fun√ß√£o para tocar som de clique
function playClickSound() {
  const clickSound = document.getElementById('clickSound');
  if (clickSound) {
    clickSound.currentTime = 0; // Reinicia caso esteja tocando
    clickSound.play().catch(e => console.log("Som de clique bloqueado:", e));
  }
}

// Fun√ß√£o para tocar m√∫sica do menu
function playMenuMusic() {
  const menuMusic = document.getElementById('menuMusic');
  if (menuMusic) {
    menuMusic.play().catch(e => console.log("M√∫sica do menu bloqueada at√© intera√ß√£o:", e));
  }
}

// Fun√ß√£o para parar m√∫sica do menu
function stopMenuMusic() {
  const menuMusic = document.getElementById('menuMusic');
  if (menuMusic) {
    menuMusic.pause();
    menuMusic.currentTime = 0;
  }
}

// Armazena volumes atuais
let volumes = {
  game: 70,
  menu: 70,
  click: 80
};

// Aplica volume aos elementos de √°udio
function applyVolumes() {
  const bgMusic = document.getElementById('backgroundMusic');
  const menuMusic = document.getElementById('menuMusic');
  const clickSound = document.getElementById('clickSound');

  if (bgMusic) bgMusic.volume = volumes.game / 100;
  if (menuMusic) menuMusic.volume = volumes.menu / 100;
  if (clickSound) clickSound.volume = volumes.click / 100;

  // Salva nos localStorage
  localStorage.setItem('gameVolumes', JSON.stringify(volumes));
}

// Carrega volumes salvos
function loadSavedVolumes() {
  const saved = localStorage.getItem('gameVolumes');
  if (saved) {
    volumes = JSON.parse(saved);
    document.getElementById('volGame').value = volumes.game;
    document.getElementById('volMenu').value = volumes.menu;
    document.getElementById('volClick').value = volumes.click;
  }
  applyVolumes();
}

// Atualiza volume por tipo
function updateVolume(type, delta) {
  volumes[type] = Math.max(0, Math.min(100, volumes[type] + delta));
  document.getElementById(`vol${type.charAt(0).toUpperCase() + type.slice(1)}`).value = volumes[type];
  applyVolumes();
}
// Fun√ß√£o para tocar m√∫sica (s√≥ ap√≥s intera√ß√£o)
function playBackgroundMusic() {
  if (bgMusic) {
    bgMusic.play().catch(e => console.log("√Åudio bloqueado at√© intera√ß√£o:", e));
  }
}

// Eventos de Configura√ß√µes
if (settingsBtn && settingsPanel && closeSettingsBtn && volumeControl) {
  settingsBtn.addEventListener('click', () => {
  playClickSound();
  settingsPanel.classList.toggle('hidden');
});
  closeSettingsBtn.addEventListener('click', () => {
  playClickSound();
  settingsPanel.classList.add('hidden');
});
  volumeControl.addEventListener('input', () => {
    if (bgMusic) bgMusic.volume = volumeControl.value;
  });
}

// Evento de Cr√©ditos
if (creditsBtn) {
  creditsBtn.addEventListener('click', () => {
  playClickSound();
  document.getElementById('creditsModal').classList.remove('hidden');
});
}

// Fecha modal ao clicar fora
document.getElementById('creditsModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('creditsModal')) {
    document.getElementById('creditsModal').classList.add('hidden');
  }
});
  </script>
</body>
</html>